# 13ç»„demoç†è§£rollup æ’ä»¶ä»¬

## ğŸ“–é˜…è¯»æœ¬æ–‡ï¼Œä½ å°†:
1. å¯¹ `rollup` æœ‰åˆæ­¥è®¤è¯†ï¼Œç†è§£å®ƒçš„ä¸»è¦ä½¿ç”¨åœºæ™¯ã€‚
2. è·Ÿéšä½œè€…ä¸€ä¸€äº†è§£é‚£äº›**ä¸»æµæ’ä»¶éƒ½èƒ½åšä»€ä¹ˆ**ã€‚ï¼ˆå®˜æ–¹æ–‡æ¡£çš„ä¸€å¥è¯ç®€ä»‹å¤ªéš¾ä»¥ç†è§£äº†ï¼‰
3. æ”¶è·ä¸€ç³»åˆ—ï¼ˆ13ç»„ï¼‰ `demo` æºç ï¼Œå¯ä»¥ `fork` ä¸‹æ¥è‚†æ„æ‘†å¼„ã€‚ 

## å‰è¨€ã€æœ‰äº† `webpack`, ä¸ºå•¥è¿˜éœ€è¦ `rollup`

æåˆ° `rollup` å®ƒæ€»æ˜¯è¢«æå‡ºæ¥ `webpack` è¿›è¡Œæ¯”è¾ƒï¼Œä½†çœŸæ­£ä½¿ç”¨è¿‡ `rollup` çš„äººå´å¯ä»¥æ¸…æ™°åœ°æ„Ÿå—åˆ°ï¼Œå°å·§è½»ä¾¿çš„å®ƒï¼ŒçœŸæ­£çš„å‘åŠ›ç‚¹å’Œ `webpack` å¹¶ä¸ç›¸åŒï¼š

`webpack` çš„ä¸€ä¸ªç†å¿µæ˜¯â€œä¸‡ç‰©çš†æ˜¯æ¨¡å—â€ï¼Œåœ¨æ­¤ç†å¿µä¸‹ï¼Œ`webpack` å…·å¤‡å¼ºåŠ›çš„å¤„ç†å„ç±»èµ„æºï¼Œæ„å»º `webåº”ç”¨` çš„èƒ½åŠ›ï¼Œå½“å‰ç¬¬ `version 5.x` å¼•å…¥çš„â€œæ¨¡å—è”é‚¦â€æ›´æ˜¯å¥ åŸºäº†å¾®åº”ç”¨æ—¶ä»£çš„éœ¸ä¸»åœ°ä½ã€‚  

`rollup.js` ä»ä¸€å¼€å§‹ï¼Œå°±æ²¡æœ‰é‚£æ ·å®å¤§çš„æ„¿æ™¯ï¼Œå®ƒæè¿°è‡ªå·±æ˜¯ï¼šâ€œä¸€ä¸ª `JavaScript` æ¨¡å—æ‰“åŒ…å™¨â€ã€‚è‡´åŠ›äºâ€œå°†å°å—çš„ä»£ç ç¼–è¯‘æˆå¤§çš„å¤æ‚çš„ä»£ç â€ã€‚

å“ªæ€•å®ƒåç»­ä¹Ÿå…·å¤‡äº†å„ç§å„æ ·çš„æ’ä»¶ï¼Œä½†è¿™äº›æ’ä»¶å®é™…ä¸Šä¹Ÿåªæ˜¯è¿™ä¸ªâ€œ`JavaScript` æ¨¡å—æ‰“åŒ…å™¨â€èƒ½åŠ›çš„ä¸€äº›è¡¥å……ã€‚

ç›¸æ¯”äº `webpack`ï¼Œ`rollup.js`çš„ä¼˜åŠ¿åœ¨äºï¼š  
1. `api` ç®€å•ï¼Œå­¦ä¹ æˆæœ¬ä½ã€‚ï¼ˆè¿™ç‚¹éš¾é“ä¸é‡è¦å—...`webpack` å­¦èµ·æ¥çœŸçš„å¥½éš¾ï¼‰  
2. å› ä¸ºä¸“æ³¨æ„å»ºå‡ºçš„ä»£ç ä½“ç§¯æ›´å°ã€‚ï¼ˆ`rollup.js` çš„æ„å»ºç»“æœå°±æ˜¯çº¯çº¯çš„ `js`ï¼Œå¹¶ä¸ä¼šè¢« `__webpack_require__` ä¹‹ç±»çš„ä»£ç å¢åŠ ä»£ç é‡ï¼‰  
3. çƒ­é—¨å·¥å…· `vite` é‡‡ç”¨äº†å®ƒå½“ç”Ÿäº§æ„å»ºå·¥å…·ã€‚ï¼ˆæœ€è¿‘å„å¤§å‚éƒ½åœ¨çº·çº·è¯•æ°´ `vite` è½åœ°ï¼Œä¸èƒ½ä¸è¯´æ˜¯ä¸ªæœºä¼šå§ï¼Ÿï¼‰



å¦‚æœä½ è¿˜ä¸å¤ªæ¸…æ¥š `rollup.js` æ„å»ºå‡ºæ¥çš„æ˜¯ä»€ä¹ˆï¼Œé‚£å€’ä¹Ÿä¸å¦¨å…ˆçœ‹çœ‹æˆ‘ä¹‹å‰çš„å¦ä¸€ç¯‡æ–‡ç« ï¼š[ã€Šè¯´ä¸æ¸…rollupèƒ½è¾“å‡ºå“ª6ç§æ ¼å¼ğŸ˜¥å·®ç‚¹è¢«é„™è§†ã€‹](https://juejin.cn/post/7051236803344334862)  

okï¼Œé—²è¨€åºŸè¯­ä¸å¤šèŠï¼Œè®©æˆ‘ä»¬é€šè¿‡ `13ç»„demo` ä¸€ä¸€è®¤è¯† `rollup.js` ç”Ÿæ€é‡Œé‚£äº›å¿…ä¸å¯å°‘çš„æ ¸å¿ƒæ’ä»¶ï¼Œéƒ½æœ‰ä»€ä¹ˆèƒ½åŠ›ï¼

Demoåœ°å€ï¼š[https://github.com/zhangshichun/rollup-demos/tree/master/base-plugins](https://github.com/zhangshichun/rollup-demos/tree/master/base-plugins)

## ä¸€ã€commonjs æ’ä»¶

> å®˜æ–¹æ–‡æ¡£ç®€ä»‹ï¼šå°† CommonJS æ¨¡å—è½¬æ¢ä¸º ES6ï¼Œè¿™æ ·å®ƒä»¬å°±å¯ä»¥åŒ…å«åœ¨ Rollup åŒ…ä¸­ã€‚

![](https://cdn.jsdelivr.net/gh/zhangshichun/blog-images/imgs/2022-02-25-01.png)

æˆ‘ç»™ç¿»è¯‘ä¸€ä¸‹ï¼š

> è™½ç„¶ `rollup.js` é»˜è®¤æ”¯æŒçš„æ˜¯ `esm` æ ¼å¼çš„æ¨¡å—åŒ–ï¼Œä½†æœ‰äº†å®ƒï¼Œä½ å°±èƒ½åœ¨é¡¹ç›®é‡Œå¯¼å…¥ `commonjs` æ ¼å¼çš„æ–‡ä»¶/æ¨¡å—å•¦ã€‚

å¦‚æœä¸Šé¢è¿™å¥è¯è¿˜æ˜¯è®©ä½ ä¼¼æ‡‚éæ‡‚ï¼Œä¸å¤ªç†è§£å®ƒåˆ°åº•è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Œæ²¡å…³ç³»ï¼Œæ˜¥å“¥ä¸ºä½ å‡†å¤‡äº†ä¸€ä¸ª `demo`ã€‚  

Demoè¯¦è§£ï¼š

æœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼Œåˆ†åˆ«æ˜¯ `index.js` å’Œ `answer.js`ã€‚  

é¦–å…ˆæ˜¯ `index.js`ï¼š

```js
import answer from "./answer";

export const printAnswer = () => {
  // æ‰“å°
  console.log(`the answer is ${answer}`)
}
```

ç„¶åæ˜¯ `answer.js`ï¼š

```js
module.exports = 42
```

ä»¥ä¸Šä»£ç é€»è¾‘å¾ˆç®€å•ï¼Œä½†ä»”ç»†çœ‹çš„è¯ï¼Œä¹Ÿå­˜åœ¨ä¸€äº›é—®é¢˜ï¼š`answer.js` çš„å¯¼å‡ºæ¨¡å¼ `module.exports` æ˜¯ `commonjs` æ ¼å¼çš„ã€‚  
å½“æˆ‘ä»¬ä½¿ç”¨æ²¡æœ‰æ’ä»¶çš„ `rollup` è¿›è¡Œæ‰“åŒ…æ—¶(æ‰§è¡Œå‘½ä»¤ `yarn build-commonjs-no-plugin`)ï¼Œæ§åˆ¶å°ä¼šç›´æ¥æŠ¥é”™ï¼š

> Error: 'default' is not exported by commonjs/answer.js

æ„æ€å¾ˆç®€å•ï¼š`answer.js` æ‰€ä½¿ç”¨çš„ `commonjs`çš„å¯¼å‡ºæ–¹å¼ï¼Œå†³å®šäº†å®ƒæ— æ³•è¢«æ™®é€šjsæ­£å¸¸ `import`ã€‚

å› æ­¤å°±å¼•å‡ºäº†ä¸€ä¸ªé—®é¢˜ï¼š

> åº”è¯¥å¦‚ä½•å¯¼å…¥ `commonjs` æ ¼å¼çš„æ–‡ä»¶/æ¨¡å—ï¼Ÿ

ç­”æ¡ˆä¾¿æ˜¯ï¼š`@rollup/plugin-commonjs` ã€‚

å¼•å…¥è¯¥æ’ä»¶åï¼Œè¿›è¡Œæ‰“åŒ…ï¼ˆæ‰§è¡Œå‘½ä»¤ `yarn build-commonjs`ï¼‰ã€‚

![](https://cdn.jsdelivr.net/gh/zhangshichun/blog-images/imgs/2022-02-25-02.png)

æ„å»ºç»“æœç»ˆäºæ­£å¸¸äº†ï¼`commonjs` æ ¼å¼çš„æ–‡ä»¶ï¼Œä¹Ÿè¢«æ„å»ºåˆ°äº†äº§ç‰©ä¹‹ä¸­ã€‚

## äºŒã€node-resolve æ’ä»¶

> å®˜æ–¹æ–‡æ¡£ç®€ä»‹ï¼šä½¿ç”¨ "node è§£æç®—æ³•" æ¥å®šä½æ¨¡å—ï¼Œç”¨äºä½¿ç”¨ `node_modules` ä¸­çš„ç¬¬ä¸‰æ–¹æ¨¡å—ã€‚

![](https://cdn.jsdelivr.net/gh/zhangshichun/blog-images/imgs/2022-02-25-03.png)

çœ‹åˆ°è¿™å¥æ€»ç»“ï¼Œè‚¯å®šæœ‰äººå¾ˆæ‡µé€¼ï¼Œä»€ä¹ˆæ˜¯â€œnode è§£æç®—æ³•â€?

å®˜æ–¹åœ°å€ï¼š[http://nodejs.cn/api/modules.html#all-together](http://nodejs.cn/api/modules.html#all-together)

å®ƒè¯¦ç»†é˜è¿°äº† `commonjs` ä¸­å…³äº `require()` æ–¹æ³•çš„ç”Ÿæ•ˆç»†èŠ‚ï¼ŒåŠå…¶ä¼ªä»£ç ã€‚

ä¸­æ–‡ä¼ªä»£ç ç¿»è¯‘ä¸‹æ ¸å¿ƒå†…å®¹ï¼š

```js
å‡è®¾æˆ‘ä»¬åœ¨ Y è·¯å¾„ä¸‹ï¼Œä½¿ç”¨äº† require(X)

1. å‡å¦‚ X æ˜¯ node æ ¸å¿ƒæ¨¡å—ï¼Œç›´æ¥è¿”å›è¯¥æ¨¡å—ã€‚
   // â†‘ æ¯”å¦‚ require('path')

2. å‡å¦‚ X ä»¥ '/' ä½œä¸ºå¼€å¤´ï¼Œå°† Y è®¾ä¸ºæ–‡ä»¶æ ¹ç³»ç»Ÿã€‚
   // â†‘ å­˜ç–‘ï¼Œå¾…éªŒè¯

3. å‡å¦‚ X ä»¥ './' æˆ– '../' æˆ– '/' å¼€å¤´
  åˆ™ï¼š
    a. æ‰§è¡Œæ–¹æ³•ï¼šæ‰¾æ–‡ä»¶(Y + X)  
    b. æ‰§è¡Œæ–¹æ³•ï¼šæ‰¾æ–‡ä»¶å¤¹(Y + X)
    c. å¦‚æœ a å’Œ b éƒ½æ²¡æ‰¾åˆ°ï¼ŒæŠ›å‡ºé”™è¯¯
   // â†‘ å…³äºç›¸å¯¹è·¯å¾„çš„è§£é‡Š

4. å¦‚æœ X ä»¥ '#' å¼€å¤´ï¼Œæ‰§è¡Œæ–¹æ³•ï¼š è·å–åŒ…å¯¼å…¥(X, dirname(Y))

5. æ‰§è¡Œæ–¹æ³•ï¼šè·å–å½“å‰åŒ…(X, dirname(Y))

6. æ‰§è¡Œæ–¹æ³•ï¼šè·å–nodeæ¨¡å—(X, dirname(Y))

7. æŠ›å‡ºé”™è¯¯ï¼šnot found

// åé¢è¿˜æœ‰å…³äºå„ç§æ–¹æ³•å„ç§ç»†èŠ‚çš„æè¿°ï¼Œå°±ä¸åœ¨æœ¬æ–‡ç»†è¯´äº†
```

è¯´äº†è¿™ä¹ˆå¤šï¼Œè¿™å’Œ `@rollup/plugin-node-resolve` æœ‰å•¥å…³ç³»å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œå› ä¸ºä¸Šé¢æè¿°çš„æ–¹å¼å±äº `commonjs`ï¼Œè€Œ `rollup.js` é»˜è®¤çš„æ–‡ä»¶å®šä½æ–¹å¼å±äº `esm`ï¼Œä¸­é—´å­˜åœ¨ä¸€äº›å·®å¼‚ã€‚

æ¯”å¦‚ï¼š

> import a from './answer'

åœ¨ `@rollup/plugin-node-resolve` æ’ä»¶çš„å¸®åŠ©ä¸‹ï¼Œæ‰èƒ½æˆåŠŸå‘½ä¸­ï¼š`'./answer/index.js'` æ–‡ä»¶ã€‚

å¯¹ç…§ç»„ï¼š  
1. æ²¡æœ‰`@rollup/plugin-node-resolve` æ’ä»¶çš„æ„å»ºï¼ˆæ‰§è¡Œå‘½ä»¤ `yarn build-node-resolve-no-plugin`ï¼‰ã€‚  
> æŠ¥é”™ï¼š[!] Error: Could not resolve './answer' from node-resolve/index.js

2. æœ‰`@rollup/plugin-node-resolve` æ’ä»¶çš„æ„å»ºï¼ˆæ‰§è¡Œå‘½ä»¤ `yarn build-node-resolve`ï¼‰ã€‚æ„å»ºæˆåŠŸï¼

## ä¸‰ã€babel æ’ä»¶
> å®˜æ–¹ç®€ä»‹ï¼šä¸€ä¸ª `Rollup` æ’ä»¶ï¼Œç”¨äº `Rollup` å’Œ `Babel` ä¹‹é—´çš„æ— ç¼é›†æˆã€‚  

![](https://cdn.jsdelivr.net/gh/zhangshichun/blog-images/imgs/2022-02-25-04.png)

è¿™ä¸ªå€’æ˜¯ä¸éš¾ç†è§£ï¼Œç†Ÿæ‚‰ `Babel` çš„åŒå­¦åº”è¯¥å¾ˆå®¹æ˜“æ˜ç™½å®ƒçš„ç”¨é€”ã€‚  

ç¿»è¯‘ä¸‹ï¼š
> ä½¿ç”¨æœ¬æ’ä»¶ï¼Œå¯ä»¥é€šè¿‡ `Babel` çš„èƒ½åŠ›å°†ä½ æ‰€å†™çš„ `es6/es7` ä»£ç ç¼–è¯‘è½¬æ¢ä¸º `es5` çš„ï¼Œä»¥é€‚ç”¨é‚£äº›æ›´å¤è€çš„æµè§ˆå™¨ã€‚

demoè®²è§£ï¼š  
åœ¨`index.js` ç¼–å†™å¦‚ä¸‹ä»£ç ï¼š
```js
const sleep = (timestamp) => {
  return new Promise((resolve) => {
    setTimeout(() => { resolve() }, timestamp)
  })
}

export const printAnswer = async () => {
  await sleep(3000)
  console.log('I am awake')
}
```
å¯¹ç…§ç»„ï¼š
1. ä¸ä½¿ç”¨ `@rollup/plugin-babel` æ‰“åŒ…ï¼ˆæ‰§è¡Œ `yarn build-babel-no-plugin`ï¼‰å‡ºæ¥çš„ä»£ç ï¼š**åŸºæœ¬æ²¡æœ‰å˜åŒ–ï¼Œè¿˜æ˜¯æœ‰ `async` å’Œ `await`** ã€‚
2. ä½¿ç”¨ `@rollup/plugin-babel` æ‰“åŒ…ï¼ˆæ‰§è¡Œ `yarn build-babel`ï¼‰å‡ºæ¥çš„ä»£ç ï¼š**æ²¡æœ‰ `await` å’Œ `async` äº†ï¼Œç¼–è¯‘æˆäº†å…¼å®¹æ€§æ›´å¼ºçš„ä»£ç ** ã€‚

> `babel` åçš„ä»£ç å—å¤ªé•¿äº†ï¼Œæœ‰70è¡Œï¼Œå°±ä¸æˆªå›¾äº†ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä¸‹è½½ `demo` è‡ªè¡Œç¼–è¯‘ã€‚

## å››ã€alias æ’ä»¶
> å®˜æ–¹ç®€ä»‹ï¼šä¸€ä¸ªåœ¨æ„ä»¶åŒ…æ—¶å®šä¹‰â€œåˆ«åâ€çš„ `Rollup` æ’ä»¶ã€‚

![](https://cdn.jsdelivr.net/gh/zhangshichun/blog-images/imgs/2022-02-25-05.png)

ä¸€ä¸ªå¾ˆç®€å•çš„åŠŸèƒ½ï¼Œä¸ºå•¥å®˜æ–¹æ€»èƒ½åšåˆ°è¯´çš„ä¸æ¸…ä¸æ¥šå‘¢...(å°¤å…¶æ˜¯å¯¹é‚£äº›ä¸ç†Ÿæ‚‰ `alias` ç‰¹æ€§çš„æ–°äºº)

å¥½å§ï¼Œæˆ‘ç¿»è¯‘ä¸€ä¸‹ï¼š
> ä½¿ç”¨è¿™ä¸ªæ’ä»¶ï¼Œä½ å¯ä»¥åœ¨å¼•å…¥æ–‡ä»¶æ—¶ï¼Œä½¿ç”¨ä¸€ä¸ª `åˆ«å` æ¥ä»£æ›¿é‚£äº›å›ºå®šçš„è·¯å¾„ã€‚

æ¯”å¦‚è¯´ï¼Œä¸šç•Œæœ€å¸¸è§çš„åšæ³•å°±æ˜¯æŠŠ `é¡¹ç›®æ ¹ç›®å½•/src` è¿™ä¸ªè·¯å¾„å®šä¹‰ä¸ºåˆ«å `@`ã€‚å› æ­¤ï¼š  
`import "@/index.js"`ä¾¿ç­‰ä»·äº `import "é¡¹ç›®æ ¹ç›®å½•/src/index.js"` ã€‚

demoè¯¦è§£ï¼š   
è·¯å¾„ï¼š`/a/b/answer.js`
```js
export default 42;
```
è·¯å¾„ `index.js`
```js
import answer from "@/answer"

export const printAnswer = async () => {
  console.log(`answer is ${answer}`)
}
```
å¾ˆæ˜¾ç„¶ï¼Œä¸å€ŸåŠ©æ’ä»¶ç›´æ¥æ„å»ºï¼Œæ˜¯æ— æ³• `import` åˆ°æ­£ç¡®çš„ `answer.js`çš„ã€‚

å¯¹ç…§ç»„ï¼š  

1. ä¸ä½¿ç”¨ `@rollup/plugin-alias`ï¼Œæ„å»ºï¼ˆæ‰§è¡Œå‘½ä»¤ `yarn build-alias-no-plugin`ï¼‰çš„äº§ç‰©ï¼š 

```js
import answer from '@/answer';

const printAnswer = async () => {
  console.log(`answer is ${answer}`);
};

export { printAnswer };
```
(å¾ˆæ˜¾ç„¶å¹¶æ²¡æœ‰å°† `answer.js` æ„å»ºè¿›æ¥)

2. ä½¿ç”¨ `@rollup/plugin-alias`ï¼Œæ„å»ºï¼ˆæ‰§è¡Œå‘½ä»¤ `yarn build-alias`ï¼‰çš„äº§ç‰©ï¼š

```js
var answer = 42;

const printAnswer = async () => {
  console.log(`answer is ${answer}`);
};

export { printAnswer };
```
å¤ªæ£’äº†ï¼Œæ­£æ˜¯æˆ‘ä»¬æ‰€æœŸæœ›çš„ï¼

## äº”ã€beep æ’ä»¶

> å®˜æ–¹ç®€ä»‹ï¼šå½“æ„å»ºç»“æŸé”™è¯¯æ—¶ä¼šå‘å‡ºå˜Ÿå˜Ÿå£°ã€‚

å–œæè€Œæ³£ï¼ç»ˆäºé‡åˆ°ä¸€ä¸ªèƒ½æ¸…æ™°è‡ªèº«åŠŸèƒ½çš„â€œå®˜æ–¹ç®€ä»‹â€ï¼

![](https://cdn.jsdelivr.net/gh/zhangshichun/blog-images/imgs/2022-02-25-06.png)

æ—¢ç„¶æ„æ€æ˜äº†ï¼Œé‚£ç›´æ¥ä¸Š `demo`ï¼š  
`index.js`
```js
export const printAnswer = () => {
  await console.log(`answer is ${answer}`)
}
```
åœ¨æ™®é€šå‡½æ•°é‡Œå†™ `await` æ˜¾ç„¶ä¼šè§¦å‘æ„å»ºé”™è¯¯ã€‚  

å¯¹ç…§ç»„ï¼š  
1. ä¸ä½¿ç”¨ `@rollup/plugin-beep` æ’ä»¶ï¼Œæ„å»ºï¼ˆæ‰§è¡Œå‘½ä»¤ `yarn build-beep-no-plugin`ï¼‰æŠ¥é”™æ—¶ä¼šæŠ¥é”™ï¼Œä½†æ²¡æœ‰â€œå˜Ÿå˜Ÿâ€å£°ã€‚  
2. ä½¿ç”¨ `@rollup/plugin-beep` æ’ä»¶ï¼Œæ„å»ºï¼ˆæ‰§è¡Œå‘½ä»¤ `yarn build-beep`ï¼‰æŠ¥é”™æ—¶å‘å‡ºâ€œå˜Ÿå˜Ÿâ€å£°ã€‚  
ï¼ˆæƒ³äº²è‡ªéªŒè¯çš„æœ‹å‹æ³¨æ„äº†ï¼Œç›´æ¥åœ¨ `vscode` ç»ˆç«¯å†…æ‰§è¡Œæ˜¯æ²¡å£°éŸ³çš„ï¼Œç”¨ç³»ç»Ÿå‘½ä»¤è¡Œå·¥å…·å§ï¼‰

## å…­ã€html æ’ä»¶
> å®˜æ–¹ç®€ä»‹ï¼šä¸€ä¸ª `Rollup` æ’ä»¶ï¼Œå®ƒåˆ›å»º `HTML` æ–‡ä»¶æ¥ä¸º `Rollup` æ„å»ºçš„åŒ…æä¾›æœåŠ¡ã€‚  

![](https://cdn.jsdelivr.net/gh/zhangshichun/blog-images/imgs/2022-02-25-07.png)

æˆ‘ç®€å•ç¿»è¯‘ä¸‹ï¼š
> æ­¤æ’ä»¶å¯ä»¥åˆ›å»ºä¸€ä¸ª `HTML` æ–‡ä»¶ï¼Œå¹¶ä¸”åœ¨å…¶ä¸­å¼•ç”¨ `Rollup` æ„å»ºçš„åŒ…ã€‚

æ˜¯ä¸æ˜¯æ¸…æ™°å¤šäº†ï¼Ÿ  

è¿™ä¸ªåŠŸèƒ½æ€§è´¨çš„ `demo` å°±ä¸æä¾›å¯¹ç…§ç»„äº†ï¼Œæ‰§è¡Œï¼š`yarn build-html`ï¼Œäº§ç‰©ä¸­åŒ…å«äº†ä¸€ä¸ª `index.html`ï¼š
```html

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Rollup Bundle</title>
    
  </head>
  <body>
    <script src="bundle.js" type="module"></script>
  </body>
</html>
```

## ä¸ƒã€inject æ’ä»¶
> å®˜æ–¹ç®€ä»‹ï¼šä¸€ä¸ª Rollup æ’ä»¶ï¼Œç”¨äºæ‰«ææ¨¡å—çš„å…¨å±€å˜é‡ï¼Œå¹¶åœ¨å¿…è¦æ—¶æ³¨å…¥`import`è¯­å¥ã€‚

è¿™ä¸ªç®€ä»‹å…¶å®è¿˜ç®—ä¸­è§„ä¸­çŸ©ã€‚

æˆ‘ç¨å¾®ç¿»è¯‘ä¸‹ï¼š

> ä½ å¯ä»¥å°†ä¸€äº›æ¨¡å—å®šä¹‰ä¸ºâ€œå…¨å±€å˜é‡â€ï¼Œåœ¨é¡¹ç›®ä¸­ä½¿ç”¨æ—¶æ— éœ€å†å†™ `import` è¯­å¥ã€‚å®é™…åœ¨æ„å»ºæ—¶ï¼Œæ­¤ç»„ä»¶ä¼šå‘ç°å®ƒä»¬å¹¶è‡ªåŠ¨åœ¨æ–‡ä»¶ä¸­è¡¥å…¨ `import` è¯­å¥ã€‚

æ¯”å¦‚ï¼Œå¯ä»¥å°† `lodash` å®šä¹‰ä¸ºå…¨å±€å˜é‡ `_`ï¼Œè¿™æ ·å°±å¯ä»¥éšæ—¶éšåœ°åœ°ä½¿ç”¨ `_.xxx`ï¼Œå¹¶ä¸”åœ¨æ„å»ºæ—¶ï¼Œæ­¤æ’ä»¶ä¼šè‡ªåŠ¨å¸®ä½ è¡¥å…¨ï¼š  
`import _ from 'lodash'`ã€‚

`demo`è¯¦è§£ï¼š  
`index.js`:
```js
export const printAnswer = () => {
  console.log(_.includes([1,2,3], 1))
}
```
ä»¥ä¸Šç›´æ¥ä½¿ç”¨äº†ä¸€ä¸ªæœªæ›¾å®šä¹‰çš„å…¨å±€å˜é‡ `_`ï¼Œæ­£å¸¸æ„å»ºè‚¯å®šä¼šæŠ¥é”™ã€‚

å¯¹ç…§ç»„ï¼š  
1. ä¸ä½¿ç”¨`@rollup/plugin-inject` æ’ä»¶ï¼Œæ„å»ºï¼ˆæ‰§è¡Œ `yarn build-inject-no-plugin`ï¼‰çš„æ„å»ºäº§ç‰©ï¼š**ä»£ç æ¯«æ— å˜åŒ–**ã€‚

2. ä½¿ç”¨`@rollup/plugin-inject` æ’ä»¶ï¼Œæ„å»ºï¼ˆæ‰§è¡Œ `yarn build-inject`ï¼‰çš„æ„å»ºäº§ç‰©ï¼š
```js
import _ from 'lodash';

const printAnswer = () => {
  console.log(_.includes([1,2,3], 1));
};

export { printAnswer };
```
æ„å»ºäº§ç‰©é‡Œï¼ŒæŒ‰éœ€å¼•å…¥äº†`lodash`ï¼Œéå¸¸æ™ºèƒ½ã€‚

## å…«ã€multi-entry æ’ä»¶

> å®˜æ–¹ç®€ä»‹ï¼šä¸€ä¸ª `Rollup` æ’ä»¶ï¼Œå…è®¸å¯¹ä¸€ä¸ª `bundle` ä½¿ç”¨å¤šä¸ªå…¥å£ç‚¹ã€‚

å®˜æ–¹ç®€ä»‹å…¶å®è¡¨ç¤ºçš„è¿˜æŒºæ˜ç™½çš„ï¼Œå¤šä¸ªå…¥å£çš„æ–‡ä»¶ï¼Œå¯ä»¥æ‰“åŒ…åˆ°ä¸€ä¸ª `bundle` ä¹‹ä¸­ã€‚

demoè¯¦è§£ï¼š  
`a.js`
```js
export const printHello = () => {
  console.log('hello')
}
```
`b.js`
```js
export const printHello = () => {
  console.log('hello')
}
```
æŠŠ `rollup` çš„é…ç½®æ–‡ä»¶ä¹Ÿåšä¸€å®šæ”¹åŠ¨ï¼š
```js
export default {
  input: [path.resolve(__dirname, './a.js'), path.resolve(__dirname, './b.js')],
  output: {
    dir: path.resolve(__dirname, 'out'),
    format: 'esm'
  },
};
```

å¯¹ç…§ç»„ï¼š
1. ä¸ä½¿ç”¨ `@rollup/plugin-multi-entry` æ’ä»¶ï¼Œåœ¨æ„å»ºï¼ˆæ‰§è¡Œå‘½ä»¤ `yarn build-multi-entry-no-plugin`ï¼‰ä¹‹åï¼Œå…¶äº§å‡ºä¸ºï¼š
```js
out/a.js
// å’Œ
out/b.js
```
æ˜¯çš„ï¼Œå¹¶æ²¡æœ‰è¢«åˆå¹¶åˆ°ä¸€ä¸ª `bundle` ä¸­ã€‚  

2. ä½¿ç”¨ `@rollup/plugin-multi-entry` æ’ä»¶ï¼Œåœ¨æ„å»ºï¼ˆæ‰§è¡Œå‘½ä»¤ `yarn build-multi-entry`ï¼‰ä¹‹åï¼Œå…¶äº§å‡ºä¸ºï¼š  
`out/multi-entry.js`
```js
const printHello = () => {
  console.log('hello');
};

const printWorld = () => {
  console.log('world');
};

export { printHello, printWorld };
```
æ„å»ºç»“æœå®Œæˆäº†åˆå¹¶ï¼Œä¸¤ä¸ªå…¥å£çš„å†…å®¹å‡ºç°åœ¨äº†ä¸€ä¸ª `bundle` ä¹‹ä¸­ã€‚

## ä¹ã€replace æ’ä»¶

> å®˜æ–¹ç®€ä»‹ï¼šä¸€ä¸ª Rollup æ’ä»¶ï¼Œåœ¨æ‰“åŒ…æ—¶æ›¿æ¢æ–‡ä»¶ä¸­çš„ç›®æ ‡å­—ç¬¦ä¸²ã€‚

![](https://files.mdnice.com/user/23675/17eae556-59fc-4b6a-87c5-3841f287744b.png)

å¯ä»¥ï¼Œå®˜æ–¹ç®€ä»‹å¾ˆå‡†ç¡®ã€‚

`demo`è¯¦è§£ï¼š  

å‡è®¾ä¸€ä¸ªåœºæ™¯ï¼šä½ å¸Œæœ›æ¯æ¬¡è®¿é—®é¡µé¢æ—¶ï¼Œéƒ½èƒ½å¿«é€ŸçŸ¥é“æœ¬åŒ…æ˜¯ä½•æ—¶æ„å»ºçš„ï¼Œåº”è¯¥æ€ä¹ˆåšï¼Ÿ

å¾ˆç®€å•ï¼Œä½¿ç”¨æœ¬æ’ä»¶ï¼š `@rollup/plugin-replace`ã€‚

åªéœ€è¦åœ¨ä»£ç ä¸­å¦‚ä¸‹å®šä¹‰ï¼š

```js
window.buildTime = "__build_time__";
```
ç„¶ååœ¨ `rollup` é…ç½®ä¸­é€šè¿‡ `@rollup/plugin-replace` æ’ä»¶ï¼Œå°†å½“å‰æ„å»ºçš„æ—¶é—´æˆ³æ ¼å¼åŒ–åèµ‹å€¼ç»™ `__build_time__`ï¼Œå³å¯å®ç°åŠŸèƒ½ã€‚

å¯¹ç…§ç»„ï¼š  
1. ä¸ä½¿ç”¨ `@rollup/plugin-replace` æ’ä»¶ï¼Œæ„å»ºï¼ˆæ‰§è¡Œå‘½ä»¤ `yarn build-replace-no-plugin`ï¼‰äº§ç‰©ï¼š

```js
window.buildTime = "__build_time__";
```
2. ä½¿ç”¨ `@rollup/plugin-replace` æ’ä»¶ï¼Œæ„å»ºï¼ˆæ‰§è¡Œå‘½ä»¤ `yarn build-replace`ï¼‰äº§ç‰©ï¼š
```js
window.buildTime = "2022-02-23 22:11:04";
```
å“ˆå“ˆï¼ŒåŒç†ï¼Œæ‰“ç»„ä»¶åŒ…æ—¶ï¼Œæƒ³çŸ¥é“æ„å»º `version` ä¹Ÿå¯ä»¥ç”¨è¿™ä¸ªæ€è·¯ã€‚

## åã€run æ’ä»¶

> å®˜æ–¹ç®€ä»‹ï¼šä¸€ä¸ª `Rollup` æ’ä»¶ï¼Œä¸€æ—¦ä½ çš„ `bundle` è¢«æ„å»ºï¼Œå®ƒå°±ä¼šåœ¨ `nodejs` ä¸­è¿è¡Œã€‚

ä¸é”™çš„å®˜æ–¹ç®€ä»‹ï¼

è¿™æ˜¾ç„¶æ˜¯ä¸ºä¸€äº› `node` è„šæœ¬æˆ–è€… `node` æœåŠ¡è®¢åˆ¶çš„èƒ½åŠ›ï¼Œæ„å»ºåä¼šç«‹åˆ»è¿è¡Œæˆ–å¯åŠ¨ä¸€ä¸ªæœåŠ¡ã€‚

demoè¯¦è§£ï¼šï¼ˆè¿™å°±ä¸é…å¯¹ç…§ç»„äº†ï¼‰  
`index.js`:
```js
const printAnswer = () => {
  console.log('hello world')
}

printAnswer()
```
ä½¿ç”¨`@rollup/plugin-run` æ’ä»¶æ„å»ºï¼ˆæ‰§è¡Œå‘½ä»¤ `yarn build-run`ï¼‰ä¹‹åï¼Œæ§åˆ¶å°è¾“å‡º:
```bash
created run/out/bundle.js in 11ms
hello world
Done in 0.15s.
```
ç›´æ¥æ‰§è¡Œäº†æ„å»ºå†…å®¹ï¼Œè¾“å‡ºäº† `hello world`ã€‚

## åä¸€ã€strip æ’ä»¶

> å®˜æ–¹ç®€ä»‹ï¼šä¸€ä¸ª Rollup æ’ä»¶ï¼Œç”¨äºä»ä»£ç ä¸­åˆ é™¤ `debugger` è¯­å¥å’Œè¯¸å¦‚ `assert.equal` å’Œ `console.log` ç±»ä¼¼çš„å‡½æ•°ã€‚

emmm...å¾ˆæ¸…æ™°çš„ç®€ä»‹ï¼Œç‚¹èµã€‚

`demo` è¯¦è§£ï¼š  
`index.js`
```js
export const printAnswer = () => {
  console.log('hello, boy')
  return 42;
}
```
å¯¹ç…§ç»„ï¼š
1. ä¸ä½¿ç”¨ `@rollup/plugin-strip` æ’ä»¶ï¼Œæ„å»ºï¼ˆ`yarn build-trip-no-plugin`ï¼‰äº§ç‰©ï¼š
```js
const printAnswer = () => {
  console.log('hello, boy');
  return 42;
};

export { printAnswer };
```

2. ä½¿ç”¨ `@rollup/plugin-strip` æ’ä»¶ï¼Œæ„å»ºï¼ˆ`yarn build-trip`ï¼‰äº§ç‰©ï¼š
```
const printAnswer = () => {
  return 42;
};
export { printAnswer };
```
åœ¨ç”Ÿäº§æ„å»ºæ—¶ï¼Œè¿™ä¸ªæ’ä»¶è¿˜æ˜¯å¾ˆé‡è¦çš„ï¼Œé¿å…å°†ä¸€äº› `debugger` è¯­å¥å¸¦å…¥ç”Ÿäº§ç¯å¢ƒï¼Œæ¯•ç«Ÿ `console.log` è¿˜æ˜¯æœ‰æ€§èƒ½å¼€é”€çš„ã€‚

## åäºŒã€url æ’ä»¶
> å®˜æ–¹ç®€ä»‹ï¼šä¸€ä¸ª `Rollup` æ’ä»¶ï¼Œå°†æ–‡ä»¶å¯¼å…¥ä¸º `data-URIs` æˆ– `esm` æ ¼å¼ã€‚

![](https://cdn.jsdelivr.net/gh/zhangshichun/blog-images/imgs/2022-02-25-01.png)

è¿™æ ·è¯´æˆ–è€…æœ‰äº›è®©äººæ‘¸ä¸ç€å¤´è„‘ï¼Œé€šè¿‡ `demo` æˆ–è®¸èƒ½æ›´å®¹æ˜“ç†è§£ã€‚

`demo` è¯¦è§£ï¼š  
`index.js` åˆ†åˆ«å¼•å…¥äº†ä¸¤ä¸ª `.png` æ ¼å¼æ–‡ä»¶ï¼Œåˆ†åˆ«ä¸ºï¼š
```js
// test.png 7KB å¤§å°
import test01 from './test.png'
// test02.png 16KB å¤§å°
import test02 from './test02.png'
```
å½“æ²¡æœ‰ `@rollup/plugin-url` æ”¯æŒæ—¶ï¼Œæ„å»ºï¼ˆ`yarn build-url-no-plugin`ï¼‰è¡Œä¸ºä¸€å®šä¼šæŠ¥é”™ï¼Œå› ä¸º `js` è§£æå¼•æ“æ— æ³•è§£æ `.png` æ ¼å¼çš„æ–‡ä»¶ã€‚  

ä½†é…ä¸Š `@rollup/plugin-url` æ’ä»¶åï¼Œç»“æœä¼šæ€æ ·å‘¢ï¼Ÿ  

```
var test01 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOcAAAD2CAYAAAAtfpAeAAAAAXNS...(ç•¥)";

var test02 = "7822ffd3c90c0d9c.png";
```
å¯¹äºä¸¤å¼ å›¾ç‰‡çš„å¤„ç†å±…ç„¶å¹¶ä¸ç›¸åŒï¼  
ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ  
å®˜æ–¹æ–‡æ¡£è§£é‡Šï¼š
> å†…è”æ–‡ä»¶çš„æ–‡ä»¶å¤§å°é™åˆ¶ã€‚å¦‚æœä¸€ä¸ªæ–‡ä»¶è¶…è¿‡è¿™ä¸ªé™åˆ¶(é»˜è®¤14KB)ï¼Œå®ƒå°†è¢«å¤åˆ¶åˆ°ç›®æ ‡æ–‡ä»¶å¤¹ï¼Œå¹¶æä¾›æ•£åˆ—æ–‡ä»¶åã€‚

å› æ­¤ï¼Œ `test02.png` è¢«å¤åˆ¶åˆ°äº†ç›®æ ‡æ–‡ä»¶å¤¹ï¼Œå¹¶æä¾›äº†ä¸€ä¸ªæ–°çš„åŸºäºæ•£åˆ—çš„åç§°ï¼Œè€Œä¸”å¯¼å…¥çš„ `test02` å¹¶ä¸æ˜¯æ–‡ä»¶ï¼Œè€Œæ˜¯è¯¥æ–‡ä»¶çš„è·¯å¾„ã€‚

é‚£ä¹ˆ `test` å‘¢ï¼Ÿ

`test` æ˜¯ä½œä¸º `data URIs` è¢«å¯¼å…¥çš„ï¼Œå…³äºè¿™ç§æ ¼å¼,æƒ³è¯¦ç»†äº†è§£çš„å¯ä»¥è®¿é—®æ­¤æ–‡æ¡£æŸ¥çœ‹:
[http://nodejs.cn/api/esm.html#data-imports](http://nodejs.cn/api/esm.html#data-imports) 

ç®€å•æ¥è¯´ï¼Œé€šè¿‡è¿™ç§å½¢å¼å°† `æ–‡ä»¶` ä½œä¸ºå†…è”å½¢å¼å¼•å…¥ï¼Œå¯ä»¥å‡å°‘ç½‘ç»œè¯·æ±‚çš„æ¬¡æ•°ï¼Œæå‡é¡µé¢åŠ è½½é€Ÿåº¦ã€‚

ï¼ˆè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ­¤æ’ä»¶é’ˆå¯¹å°æ–‡ä»¶å’Œå¤§æ–‡ä»¶è¦é‡‡å–ä¸ä¸€æ ·çš„ç­–ç•¥çš„åŸå› ã€‚ï¼‰

## åä¸‰ã€post-css æ’ä»¶
(érollupå®˜æ–¹ä»“åº“ç›´æ¥æ¨èçš„æ’ä»¶)åœ°å€ï¼š[https://github.com/egoist/rollup-plugin-postcss](https://github.com/egoist/rollup-plugin-postcss)
> å®˜æ–¹ç®€ä»‹ï¼š`Rollup` å’Œ `PostCSS` ä¹‹é—´çš„æ— ç¼é›†æˆã€‚

ä¸ºä»€ä¹ˆè¦æ¨èè¿™ä¸ªæ’ä»¶ï¼Ÿå› ä¸ºå®ƒå¤ªå¼ºäº†ï¼

å®ƒä¸ä»…ä»…æ˜¯ä¸€ä¸ªæ’ä»¶è¿™ä¹ˆç®€å•ï¼Œå› ä¸ºä½¿ç”¨å®ƒï¼Œä½ å¯ä»¥è·å¾— `PostCSS` æ•´ä¸ªç¤¾åŒºçš„ç”Ÿæ€åŠ›é‡ã€‚

ä¼—æ‰€å‘¨çŸ¥ï¼Œ`PostCSS` æœ¬èº«å°±æ‹¥æœ‰è‡ªå·±çš„`æ’ä»¶ç³»ç»Ÿ`ï¼Œåœ¨é›†æˆæœ¬æ’ä»¶ä¹‹åï¼Œä½ å°†å¯ä»¥å¯¼å…¥å„ç§ `postcss æ’ä»¶`ï¼Œå®Œæˆå…³äº `css` çš„å„ç§å¤æ‚æ“ä½œã€‚
![](https://cdn.jsdelivr.net/gh/zhangshichun/blog-images/imgs/2022-02-26-01.png)
**ALL IN ONE! AMAZING!**  

`demo` è¯¦è§£ï¼š
`index.js`
```js
import './style.scss'
export const printAnswer = () => {
  console.log('answer is 42')
}
```
`style.scss`
```scss
.bg {
  color: red;
  
  .title {
    color: black;
  }
}
```
å› ä¸º `rollup.js` æœ¬èº«æ˜¯ä¸æ”¯æŒ `css` æ ¼å¼çš„ï¼Œæ›´æ˜¯ä¸æ”¯æŒ `scss` æ ¼å¼çš„ã€‚

å› æ­¤æˆ‘ä»¬çš„æ€è·¯æ˜¯ï¼š

æ„å»ºæ—¶å¼•å…¥ `rollup-plugin-css` æ’ä»¶ï¼Œå¹¶é€šè¿‡é…ç½®è®©å®ƒæ”¯æŒ `scss` çš„ç¼–è¯‘å’Œé“¾æ¥æ”¯æŒã€‚

```js
export default {
  ...
  plugins: [
    postcss({
      extract: true,  // cssé€šè¿‡é“¾æ¥å¼•å…¥
      use: ["sass"],  // ç¼–è¯‘ sass
    })
  ],
  ...
};
```

æ‰§è¡Œå‘½ä»¤: `yarn build-post-css`

è¾“å‡ºï¼š
`bundle.css`
```css
.bg {
  color: red;
}
.bg .title {
  color: black;
}
```
å®Œç¾ã€‚

## åå››ã€é‚£äº›æœªæä¾› `demo` çš„æ’ä»¶

å› ä¸ºæœ¬æ–‡ç¯‡å¹…æœ‰é™ï¼Œå¾ˆå¤šâ€œå®˜æ–¹æ¨èâ€çš„æ’ä»¶ä¹Ÿå¹¶æœªèƒ½å…¨éƒ¨æä¾›æ’ä»¶ï¼Œå…¶ä¸­ä»¥â€œæ ¼å¼è§£æâ€ç±»ä¸ºä¸»ï¼Œæ¯”å¦‚ï¼š
1. `@rollup/plugin-dsv`
2. `@rollup/plugin-graphql`
3. `@rollup/plugin-image`
4. `@rollup/plugin-json`
5. `@rollup/plugin-wasm`
6. `@rollup/plugin-yaml`

ä»¥ä¸Šè¿™äº›éƒ½ä¸“æ³¨äºè§£å†³ä¸€ä»¶äº‹ï¼šâ€œä¹‹å‰ `rollup` ä¸æ”¯æŒ `xx` æ ¼å¼çš„æ–‡ä»¶ï¼Œç°åœ¨æˆ‘æƒ³åŠæ³•è®©å®ƒæ”¯æŒâ€ã€‚  
 
å½“æˆ‘ä»¬éœ€è¦ä½¿ç”¨æ—¶ï¼Œçœ‹çœ‹æ–‡æ¡£ï¼Œé€šå¸¸å°±èƒ½å¾ˆå¿«ä¸Šæ‰‹ï¼Œæ²¡å•¥ç†è§£éš¾åº¦ã€‚

> é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›æ¯”è¾ƒå†·é—¨çš„æ’ä»¶ï¼Œä¹Ÿæ²¡åˆ—å‡ºæ¥ç»†è¯´ã€‚

## åäº”ã€åœ°å€æ±‡æ€»ï¼š

1. æˆ‘çš„å¦ä¸€ç¯‡ `rollup` ç›¸å…³æ–‡ç« ï¼šã€Šè¯´ä¸æ¸…rollupèƒ½è¾“å‡ºå“ª6ç§æ ¼å¼ğŸ˜¥å·®ç‚¹è¢«é„™è§†ã€‹[https://juejin.cn/post/7051236803344334862](https://juejin.cn/post/7051236803344334862)

2. `@rollup/plugins` å®˜æ–¹ `github`ï¼š[https://github.com/rollup/plugins](https://github.com/rollup/plugins)

3. æœ¬æ–‡ `demo` åœ°å€ï¼š[https://github.com/zhangshichun/rollup-demos/tree/master/base-plugins](https://github.com/zhangshichun/rollup-demos/tree/master/base-plugins)

4. `rollup-plugin-postcss`åœ°å€ï¼š[https://github.com/egoist/rollup-plugin-postcss](https://github.com/egoist/rollup-plugin-postcss)

## åå…­ã€ç»“æŸè¯­

æˆ‘æ˜¯`æ˜¥å“¥`ã€‚  
å¤§é¾„å‰ç«¯æ‰“å·¥ä»”ï¼Œä¾ç„¶åœ¨åŠªåŠ›å­¦ä¹ ã€‚  
æˆ‘çš„ç›®æ ‡æ˜¯ç»™å¤§å®¶åˆ†äº«æœ€å®ç”¨ã€æœ€æœ‰ç”¨çš„çŸ¥è¯†ç‚¹ï¼Œå¸Œæœ›å¤§å®¶éƒ½å¯ä»¥æ—©æ—©ä¸‹ç­ï¼Œå¹¶å¯ä»¥é£é€Ÿå®Œæˆå·¥ä½œï¼Œæ·¡å®šæ‘¸é±¼ğŸŸã€‚

ä½ å¯ä»¥åœ¨**å…¬ä¼—å·**é‡Œæ‰¾åˆ°æˆ‘ï¼š`å‰ç«¯è¦æ‘¸é±¼`ã€‚
